---
import SiteLayout from "../../layouts/SiteLayout.astro";
import WorkSubnav from "../../components/WorkSubnav.astro";
import { getCollection } from "astro:content";

async function safeCollection(name) {
	try {
		return await getCollection(name);
	} catch {
		return [];
	}
}

let projects = (await safeCollection("projects")).filter((e) => !e.data.draft);
projects.sort((a, b) => (b.data.date?.valueOf?.() ?? 0) - (a.data.date?.valueOf?.() ?? 0));
const featuredProjects = (projects.filter((p) => p.data.selected).length ? projects.filter((p) => p.data.selected) : projects).slice(0, 3);

let publications = (await safeCollection("publications")).filter((e) => !e.data.draft);
publications.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const featuredPubs = (publications.filter((p) => p.data.selected).length ? publications.filter((p) => p.data.selected) : publications).slice(0, 3);

let talks = (await safeCollection("talks")).filter((e) => !e.data.draft);
talks.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const featuredTalks = (talks.filter((t) => t.data.selected).length ? talks.filter((t) => t.data.selected) : talks).slice(0, 3);

let teaching = (await safeCollection("teaching")).filter((e) => !e.data.draft);
teaching.sort((a, b) => String(b.data.term).localeCompare(String(a.data.term)));
const featuredTeaching = teaching.slice(0, 3);
---

<SiteLayout title="Work" description="Projects, publications, talks, and teaching.">
	<section class="container mt-10 sm:mt-14">
		<h1>Work</h1>
		<p class="mt-4 max-w-prose text-zinc-800">
			A single place to browse projects, publications, talks, and teaching. Use the tabs to jump into a section, or skim highlights below.
		</p>

		<WorkSubnav />

		<div class="mt-10 grid gap-10">
			<section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
				<div class="flex flex-wrap items-end justify-between gap-4">
					<div>
						<h2 class="text-2xl">Projects</h2>
						<p class="mt-2 max-w-prose text-sm text-zinc-700">Technical write-ups and code-based work.</p>
					</div>
					<a class="btn-secondary" href="/projects/">Browse projects</a>
				</div>

				<ul class="mt-5 divide-y divide-zinc-100">
					{featuredProjects.map((p) => (
						<li class="py-4">
							<a class="no-underline hover:underline" href={`/projects/${p.slug}/`}>{p.data.title}</a>
							<p class="mt-1 text-sm text-zinc-700">{p.data.summary}</p>
						</li>
					))}
				</ul>
			</section>

			<section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
				<div class="flex flex-wrap items-end justify-between gap-4">
					<div>
						<h2 class="text-2xl">Publications</h2>
						<p class="mt-2 max-w-prose text-sm text-zinc-700">Preprints, papers, and write-ups.</p>
					</div>
					<a class="btn-secondary" href="/publications/">Browse publications</a>
				</div>

				<ul class="mt-5 divide-y divide-zinc-100">
					{featuredPubs.map((p) => (
						<li class="py-4">
							<a class="no-underline hover:underline" href={`/publications/${p.slug}/`}>{p.data.title}</a>
							<p class="mt-1 text-sm text-zinc-700">
								{p.data.authors ? `${p.data.authors} • ` : ""}
								{p.data.venue ?? ""}
							</p>
						</li>
					))}
				</ul>
			</section>

			<section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
				<div class="flex flex-wrap items-end justify-between gap-4">
					<div>
						<h2 class="text-2xl">Talks</h2>
						<p class="mt-2 max-w-prose text-sm text-zinc-700">Talks, posters, and seminar presentations.</p>
					</div>
					<a class="btn-secondary" href="/talks/">Browse talks</a>
				</div>

				<ul class="mt-5 divide-y divide-zinc-100">
					{featuredTalks.map((t) => (
						<li class="py-4">
							<a class="no-underline hover:underline" href={`/talks/${t.slug}/`}>{t.data.title}</a>
							<p class="mt-1 text-sm text-zinc-700">
								{t.data.event ? `${t.data.event} • ` : ""}
								{t.data.location ?? ""}
							</p>
						</li>
					))}
				</ul>
			</section>

			<section class="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
				<div class="flex flex-wrap items-end justify-between gap-4">
					<div>
						<h2 class="text-2xl">Teaching</h2>
						<p class="mt-2 max-w-prose text-sm text-zinc-700">Courses, sections, and instructional work.</p>
					</div>
					<a class="btn-secondary" href="/teaching/">Browse teaching</a>
				</div>

				<ul class="mt-5 divide-y divide-zinc-100">
					{featuredTeaching.map((c) => (
						<li class="py-4">
							<a class="no-underline hover:underline" href={`/teaching/${c.slug}/`}>{c.data.course}</a>
							<p class="mt-1 text-sm text-zinc-700">
								{c.data.term}{c.data.institution ? ` • ${c.data.institution}` : ""}{c.data.role ? ` • ${c.data.role}` : ""}
							</p>
						</li>
					))}
				</ul>
			</section>
		</div>
	</section>
</SiteLayout>
